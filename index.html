<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hörselassistenten</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Anpassad slider-stil */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #4b5563;
            border-radius: 2px;
        }

        .vu-meter-bar {
            transition: height 0.1s ease;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen font-sans flex flex-col">

    <!-- Header -->
    <header class="bg-slate-800 p-4 shadow-lg border-b border-slate-700">
        <div class="max-w-md mx-auto flex items-center justify-between">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i data-lucide="ear" class="text-blue-400"></i>
                Hörselassistenten
            </h1>
            <div id="statusIndicator" class="px-3 py-1 rounded-full text-xs font-semibold bg-red-900 text-red-200 animate-pulse">
                OFFLINE
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-4 overflow-y-auto">
        <div class="max-w-md mx-auto space-y-6">

            <!-- Wake Lock Status -->
            <div id="wakeLockStatus" class="hidden bg-blue-900/30 text-blue-200 text-xs text-center py-2 rounded border border-blue-800">
                <i data-lucide="sun" class="inline w-3 h-3 mr-1"></i> Skärmen hålls vaken
            </div>

            <!-- Start/Stop Section -->
            <div class="bg-slate-800 rounded-xl p-6 shadow-md border border-slate-700 text-center">
                <p class="text-slate-400 text-sm mb-4">
                    <i data-lucide="alert-triangle" class="inline w-4 h-4 mb-1 text-yellow-500"></i>
                    Använd alltid hörlurar för att undvika rundgång.
                </p>
                <button id="toggleBtn" class="w-full py-4 rounded-lg font-bold text-lg transition-all shadow-lg flex items-center justify-center gap-3 bg-green-600 hover:bg-green-500 text-white">
                    <i data-lucide="power"></i>
                    Starta Ljudet
                </button>
            </div>

            <!-- Visualizer -->
            <div class="bg-slate-800 rounded-xl p-4 shadow-md border border-slate-700 relative overflow-hidden h-32 flex items-end justify-between gap-1" id="visualizer-container">
                <!-- Bars will be injected here by JS -->
                <div class="absolute inset-0 flex items-center justify-center text-slate-500/30 font-bold text-2xl z-0 pointer-events-none">
                    VISUALISERARE
                </div>
            </div>

            <!-- Device Selection (Input & Output) -->
            <div class="bg-slate-800 rounded-xl p-5 shadow-md border border-slate-700 space-y-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-bold text-slate-300 uppercase tracking-wider">Ljudenheter</h3>
                    <button onclick="getAllDevices()" class="text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded flex items-center gap-1 transition-colors border border-slate-600">
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i> Uppdatera
                    </button>
                </div>

                <!-- Input Select -->
                <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1 flex items-center gap-2">
                        <i data-lucide="mic" class="w-3 h-3"></i> Mikrofon (Input)
                    </label>
                    <select id="micSelect" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                        <option value="" disabled selected>Laddar mikrofoner...</option>
                    </select>
                </div>

                <!-- Output Select -->
                <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1 flex items-center gap-2">
                        <i data-lucide="speaker" class="w-3 h-3"></i> Högtalare (Output)
                    </label>
                    <select id="speakerSelect" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                        <option value="" disabled selected>Laddar högtalare...</option>
                    </select>
                    <p id="outputWarning" class="hidden text-xs text-orange-400 mt-1">
                        Din webbläsare stödjer inte byte av output här. Ändra i systeminställningarna.
                    </p>
                </div>
                
                <p class="text-xs text-slate-500 italic">
                    Om USB-C-mikrofonen tar över ljudet, välj dina hörlurar manuellt i listan ovan.
                </p>
            </div>

            <!-- Controls -->
            <div class="bg-slate-800 rounded-xl p-5 shadow-md border border-slate-700 space-y-6 opacity-50 pointer-events-none transition-opacity" id="controlsArea">
                
                <!-- Gain / Volume Boost -->
                <div>
                    <div class="flex justify-between mb-1">
                        <label class="text-sm font-medium text-blue-300">Volymförstärkning</label>
                        <span id="gainVal" class="text-xs font-mono bg-slate-700 px-2 rounded">1.0x</span>
                    </div>
                    <input type="range" id="gainSlider" min="0" max="5" step="0.1" value="1" class="w-full">
                    <p class="text-xs text-slate-500 mt-1">Öka om mikrofonen är långt bort.</p>
                </div>

                <!-- Pan / Balance -->
                <div class="p-4 bg-slate-900 rounded-lg border border-slate-700">
                    <div class="flex justify-between mb-1">
                        <label class="text-sm font-medium text-green-300 flex items-center gap-1">
                            <i data-lucide="move-horizontal" class="w-4 h-4"></i> Balans
                        </label>
                        <span id="panVal" class="text-xs font-mono bg-slate-700 px-2 rounded">Mitten</span>
                    </div>
                    <div class="flex items-center gap-3 text-xs text-slate-400 font-bold">
                        <span>V (Bra öra)</span>
                        <input type="range" id="panSlider" min="-1" max="1" step="0.1" value="0" class="w-full">
                        <span>H</span>
                    </div>
                    <p class="text-xs text-slate-500 mt-2 text-center">Dra mot Vänster för att flytta ljudet till ditt friska öra.</p>
                </div>

                <!-- EQ Section -->
                <div class="space-y-4 pt-2 border-t border-slate-700">
                    <h3 class="text-sm font-bold text-slate-300 uppercase tracking-wider">Bullerreducering & Tal</h3>
                    
                    <!-- Low / Bass -->
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-slate-400">Lågbas (Buller)</span>
                            <span id="lowVal">0 dB</span>
                        </div>
                        <input type="range" id="lowSlider" min="-20" max="10" step="1" value="0" class="w-full">
                    </div>

                    <!-- Mid / Speech -->
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-yellow-400 font-bold">Röstfokus</span>
                            <span id="midVal">0 dB</span>
                        </div>
                        <input type="range" id="midSlider" min="-10" max="20" step="1" value="0" class="w-full">
                    </div>

                    <!-- High / Clarity -->
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-slate-400">Diskant (Skärpa)</span>
                            <span id="highVal">0 dB</span>
                        </div>
                        <input type="range" id="highSlider" min="-10" max="15" step="1" value="0" class="w-full">
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // Init Lucide icons
        lucide.createIcons();

        // Audio Context & Nodes
        let audioCtx;
        let streamSource;
        let gainNode;
        let pannerNode;
        let compressorNode;
        let lowEQ, midEQ, highEQ;
        let analyser;
        let isRunning = false;
        let currentStream = null;
        let animationId;
        
        // Wake Lock Sentinel
        let wakeLock = null;

        // Elements
        const toggleBtn = document.getElementById('toggleBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const controlsArea = document.getElementById('controlsArea');
        const micSelect = document.getElementById('micSelect');
        const speakerSelect = document.getElementById('speakerSelect');
        const outputWarning = document.getElementById('outputWarning');
        const visualizerContainer = document.getElementById('visualizer-container');
        const wakeLockStatus = document.getElementById('wakeLockStatus');

        // Setup Visualizer Bars
        const barCount = 20;
        const bars = [];
        for (let i = 0; i < barCount; i++) {
            const bar = document.createElement('div');
            bar.className = 'bg-blue-500 w-full mx-0.5 rounded-t-sm opacity-80';
            bar.style.height = '5%';
            visualizerContainer.appendChild(bar);
            bars.push(bar);
        }

        // Initialize Audio Context
        async function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') {
                await audioCtx.resume();
            }
        }

        // Wake Lock Logic
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLockStatus.classList.remove('hidden');
                    wakeLock.addEventListener('release', () => {
                        if (!isRunning) wakeLockStatus.classList.add('hidden');
                    });
                }
            } catch (err) {
                if (err.name !== 'NotAllowedError') {
                    console.warn(`Wake Lock error: ${err.message}`);
                }
                wakeLockStatus.classList.add('hidden');
            }
        }

        async function releaseWakeLock() {
            if (wakeLock) {
                try { await wakeLock.release(); } catch(e) {}
                wakeLock = null;
                wakeLockStatus.classList.add('hidden');
            }
        }

        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await requestWakeLock();
            }
        });

        // --- Device Management ---
        
        async function getAllDevices() {
            try {
                // Request permission temporarily to ensure labels are visible
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());

                const devices = await navigator.mediaDevices.enumerateDevices();
                
                // Filter Inputs
                const audioInputs = devices.filter(device => device.kind === 'audioinput');
                populateSelect(micSelect, audioInputs, 'Mikrofon');

                // Filter Outputs
                const audioOutputs = devices.filter(device => device.kind === 'audiooutput');
                if (audioOutputs.length > 0) {
                    populateSelect(speakerSelect, audioOutputs, 'Högtalare');
                    outputWarning.classList.add('hidden');
                } else {
                    // Some browsers/OS don't expose outputs
                    speakerSelect.innerHTML = '<option disabled>Standard (Systeminställning)</option>';
                    // Check if setSinkId is supported at all
                    if (!('setSinkId' in AudioContext.prototype) && !('setSinkId' in HTMLMediaElement.prototype)) {
                        outputWarning.classList.remove('hidden');
                    }
                }
                
                lucide.createIcons();

            } catch (err) {
                console.error("Device Error:", err);
                micSelect.innerHTML = '<option>Fel vid laddning</option>';
            }
        }

        function populateSelect(selectElement, devices, typeLabel) {
            const currentVal = selectElement.value;
            selectElement.innerHTML = '';
            
            if (devices.length === 0) {
                selectElement.innerHTML = `<option disabled>Inga ${typeLabel.toLowerCase()} hittades</option>`;
                return;
            }

            devices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.text = device.label || `${typeLabel} (${device.deviceId.slice(0,5)}...)`;
                selectElement.appendChild(option);
            });

            // Restore selection if exists, else select default
            if (currentVal && [...selectElement.options].some(o => o.value === currentVal)) {
                selectElement.value = currentVal;
            }
        }

        // --- Audio Logic ---

        async function startAudio(inputId = null) {
            try {
                await initAudio();
                await requestWakeLock();

                // Input Constraints
                const constraints = {
                    audio: {
                        deviceId: inputId ? { exact: inputId } : undefined,
                        echoCancellation: false, 
                        noiseSuppression: false, 
                        autoGainControl: false,  
                        latency: 0
                    }
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Build Graph
                streamSource = audioCtx.createMediaStreamSource(currentStream);
                gainNode = audioCtx.createGain();
                pannerNode = audioCtx.createStereoPanner();
                analyser = audioCtx.createAnalyser();
                compressorNode = audioCtx.createDynamicsCompressor(); 
                
                // EQ
                lowEQ = audioCtx.createBiquadFilter();
                lowEQ.type = 'lowshelf';
                lowEQ.frequency.value = 250;

                midEQ = audioCtx.createBiquadFilter();
                midEQ.type = 'peaking';
                midEQ.Q.value = 1;
                midEQ.frequency.value = 1500;

                highEQ = audioCtx.createBiquadFilter();
                highEQ.type = 'highshelf';
                highEQ.frequency.value = 5000;

                updateAudioParams();

                // Chain: Source -> Compressor -> LowEQ -> MidEQ -> HighEQ -> Gain -> Panner -> Analyser -> Dest
                streamSource
                    .connect(compressorNode)
                    .connect(lowEQ)
                    .connect(midEQ)
                    .connect(highEQ)
                    .connect(gainNode)
                    .connect(pannerNode)
                    .connect(analyser)
                    .connect(audioCtx.destination); // Default destination initially

                // Attempt to set output immediately if selected
                if (speakerSelect.value) {
                    await setOutputDevice(speakerSelect.value);
                }

                // Visualizer
                analyser.fftSize = 64;
                drawVisualizer();

                isRunning = true;
                updateUIState(true);

            } catch (err) {
                console.error("Start Error:", err);
                alert("Kunde inte starta ljudet. Kontrollera att du gett behörighet.");
                stopAudio();
            }
        }

        async function setOutputDevice(deviceId) {
            if (!deviceId) return;

            try {
                // Method 1: AudioContext.setSinkId (Modern/Chrome)
                if (typeof audioCtx.setSinkId === 'function') {
                    await audioCtx.setSinkId(deviceId);
                    console.log(`Output satt till ${deviceId} via AudioContext`);
                } 
                // Method 2: Fallback (unlikely needed for plain web audio but good to know)
                else {
                    console.warn("setSinkId stöds inte på denna webbläsare för AudioContext.");
                }
            } catch (err) {
                console.error("Kunde inte byta output:", err);
            }
        }

        function stopAudio() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            if (animationId) cancelAnimationFrame(animationId);
            if (streamSource) streamSource.disconnect();
            
            releaseWakeLock();
            isRunning = false;
            updateUIState(false);
            bars.forEach(bar => bar.style.height = '5%');
        }

        // --- UI & Events ---

        micSelect.onchange = async (e) => {
            if (isRunning) {
                stopAudio();
                await startAudio(e.target.value);
            }
        };

        speakerSelect.onchange = async (e) => {
            if (isRunning) {
                await setOutputDevice(e.target.value);
            }
        };

        toggleBtn.addEventListener('click', () => {
            if (isRunning) stopAudio();
            else startAudio(micSelect.value);
        });

        // Parameter Updates
        function updateAudioParams() {
            if (!isRunning) return;
            
            const gainVal = parseFloat(document.getElementById('gainSlider').value);
            gainNode.gain.value = gainVal;
            document.getElementById('gainVal').innerText = gainVal.toFixed(1) + 'x';

            const panVal = parseFloat(document.getElementById('panSlider').value);
            pannerNode.pan.value = panVal;
            let panText = "Mitten";
            if (panVal < -0.1) panText = "Vänster";
            if (panVal > 0.1) panText = "Höger";
            document.getElementById('panVal').innerText = panText;

            lowEQ.gain.value = parseFloat(document.getElementById('lowSlider').value);
            document.getElementById('lowVal').innerText = (lowEQ.gain.value > 0 ? '+' : '') + lowEQ.gain.value + ' dB';

            midEQ.gain.value = parseFloat(document.getElementById('midSlider').value);
            document.getElementById('midVal').innerText = (midEQ.gain.value > 0 ? '+' : '') + midEQ.gain.value + ' dB';

            highEQ.gain.value = parseFloat(document.getElementById('highSlider').value);
            document.getElementById('highVal').innerText = (highEQ.gain.value > 0 ? '+' : '') + highEQ.gain.value + ' dB';
        }

        ['gainSlider', 'panSlider', 'lowSlider', 'midSlider', 'highSlider'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateAudioParams);
        });

        function updateUIState(active) {
            if (active) {
                toggleBtn.innerHTML = '<i data-lucide="square" class="fill-current"></i> Stoppa Ljudet';
                toggleBtn.classList.replace('bg-green-600', 'bg-red-600');
                toggleBtn.classList.replace('hover:bg-green-500', 'hover:bg-red-500');
                statusIndicator.innerText = "LIVE";
                statusIndicator.classList.replace('bg-red-900', 'bg-green-900');
                statusIndicator.classList.replace('text-red-200', 'text-green-200');
                controlsArea.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                toggleBtn.innerHTML = '<i data-lucide="power"></i> Starta Ljudet';
                toggleBtn.classList.replace('bg-red-600', 'bg-green-600');
                toggleBtn.classList.replace('hover:bg-red-500', 'hover:bg-green-500');
                statusIndicator.innerText = "OFFLINE";
                statusIndicator.classList.replace('bg-green-900', 'bg-red-900');
                statusIndicator.classList.replace('text-green-200', 'text-red-200');
                controlsArea.classList.add('opacity-50', 'pointer-events-none');
            }
            lucide.createIcons();
        }

        function drawVisualizer() {
            if (!isRunning) return;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);
            const step = Math.floor(bufferLength / barCount);

            for (let i = 0; i < barCount; i++) {
                const value = dataArray[i * step];
                const percent = (value / 255) * 100;
                bars[i].style.height = Math.max(5, percent) + '%';
                if (percent > 80) bars[i].className = 'w-full mx-0.5 rounded-t-sm transition-all bg-red-500';
                else if (percent > 50) bars[i].className = 'w-full mx-0.5 rounded-t-sm transition-all bg-yellow-500';
                else bars[i].className = 'w-full mx-0.5 rounded-t-sm transition-all bg-blue-500';
            }
            animationId = requestAnimationFrame(drawVisualizer);
        }

        window.addEventListener('load', getAllDevices);
        if (navigator.mediaDevices) {
            navigator.mediaDevices.ondevicechange = () => {
                console.log("Devices changed");
                getAllDevices();
            };
        }
    </script>
</body>
</html>
